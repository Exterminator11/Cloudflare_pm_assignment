<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Customer Support Tickets - Insight Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
</head>
<body class="bg-white min-h-screen flex flex-col">
  <nav class="bg-[#F38020] text-black shadow-sm">
    <div class="max-w-6xl mx-auto px-6 py-4 flex flex-wrap justify-between items-center">
      <a href="index.html" class="text-lg font-semibold tracking-tight">Insight Dashboard</a>
      <div class="flex gap-1 mt-2 sm:mt-0 text-sm">
        <a href="insights.html" class="px-3 py-1.5 rounded hover:bg-[#E57010] transition">All Insights</a>
        <a href="tickets.html" class="px-3 py-1.5 rounded bg-black text-white transition">Tickets</a>
        <a href="discord.html" class="px-3 py-1.5 rounded hover:bg-[#E57010] transition">Discord</a>
        <a href="github.html" class="px-3 py-1.5 rounded hover:bg-[#E57010] transition">GitHub</a>
        <a href="email.html" class="px-3 py-1.5 rounded hover:bg-[#E57010] transition">Email</a>
        <a href="twitter.html" class="px-3 py-1.5 rounded hover:bg-[#E57010] transition">Twitter</a>
        <a href="forum.html" class="px-3 py-1.5 rounded hover:bg-[#E57010] transition">Forum</a>
      </div>
    </div>
  </nav>

  <main class="flex-1 max-w-6xl mx-auto px-6 py-12 w-full">
    <div class="flex flex-wrap justify-between items-center mb-8">
      <h1 class="text-2xl font-light tracking-tight text-black">Customer Support Tickets</h1>
      <button onclick="loadAllData()" class="px-5 py-2 bg-[#F38020] text-black rounded-lg font-medium hover:bg-[#E57010] transition-colors">
        Refresh
      </button>
    </div>

    <div id="loading" class="hidden flex justify-center py-16">
      <div class="w-10 h-10 border-2 border-[#F38020] border-t-transparent rounded-full animate-spin"></div>
    </div>

    <div id="error" class="hidden bg-red-50 border border-red-100 text-red-600 px-4 py-3 rounded-lg mb-6"></div>

    <div id="content" class="space-y-8 mb-12"></div>

    <div id="ai-analysis" class="mb-10">
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center gap-2">
          <svg class="w-5 h-5 text-[#F38020]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
          </svg>
          <h2 class="text-xl font-medium text-black">AI Product Analysis</h2>
        </div>

      </div>

      <div class="grid lg:grid-cols-2 gap-6">
        <div class="bg-gray-50 rounded-xl p-5">
          <h3 class="text-sm font-medium text-gray-500 uppercase mb-4">Tickets by Product Area</h3>
          <div class="h-64 flex items-center">
            <canvas id="categoryChart" class="w-full h-full"></canvas>
          </div>
        </div>

        <div class="bg-gray-50 rounded-xl p-5">
          <h3 class="text-sm font-medium text-gray-500 uppercase mb-4">Trend Over Time</h3>
          <div class="h-64 flex items-center">
            <canvas id="trendChart" class="w-full h-full"></canvas>
          </div>
        </div>
      </div>

      <div class="grid lg:grid-cols-3 gap-6 mt-6">
        <div class="lg:col-span-2 bg-gradient-to-br from-[#F38020]/10 to-orange-50 rounded-xl p-5">
          <h3 class="text-sm font-medium text-gray-500 uppercase mb-3">AI Recommendations</h3>
          <div id="ai-advice" class="text-sm text-gray-700 space-y-3">
            <p class="text-gray-400">Loading analysis...</p>
          </div>
        </div>

        <div class="bg-gray-50 rounded-xl p-5">
          <h3 class="text-sm font-medium text-gray-500 uppercase mb-3">Priority Focus Areas</h3>
          <div id="priority-areas" class="flex flex-wrap gap-2">
            <p class="text-gray-400 text-sm">Loading...</p>
          </div>
        </div>
      </div>
    </div>

    <div id="empty" class="hidden text-center py-16 text-gray-400">
      No tickets found
    </div>
  </main>

  <footer class="border-t border-gray-100 py-6">
    <div class="max-w-6xl mx-auto px-6 text-center text-sm text-gray-400">
      Insight Dashboard &mdash; Powered by Cloudflare Workers
    </div>
  </footer>

  <script src="shared.js"></script>
  <script>
    let categoryChart = null;
    let trendChart = null;

    async function loadAllData() {
      showLoading('loading');
      hideError('error');
      try {
        const [tickets, analysis] = await Promise.all([
          fetchTickets(),
          loadAIAnalysis()
        ]);
        renderTickets(tickets);
      } catch (err) {
        showError('error', 'Failed to load data: ' + err.message);
      } finally {
        hideLoading('loading');
      }
    }

    async function loadAIAnalysis() {
      try {
        const analysis = await fetchTicketAnalysis();
        renderCategoryChart(analysis.categories);
        renderTrendChart(analysis.timeline, analysis.categories.map(c => c.name));
        renderAIAdvice(analysis.advice, analysis.priorityAreas);
      } catch (err) {
        console.error('AI analysis failed:', err);
        document.getElementById('ai-advice').innerHTML = '<p class="text-red-500">Failed to load AI analysis</p>';
      }
    }

    function renderCategoryChart(categories) {
      const canvas = document.getElementById('categoryChart');
      const container = canvas.parentElement;
      
      if (categoryChart) {
        categoryChart.destroy();
        categoryChart = null;
      }
      
      canvas.remove();
      const newCanvas = document.createElement('canvas');
      newCanvas.id = 'categoryChart';
      newCanvas.className = 'w-full h-full';
      container.appendChild(newCanvas);

      const colors = ['#3b82f6', '#8b5cf6', '#ef4444', '#10b981', '#f59e0b', '#6366f1', '#ec4899', '#14b8a6'];

      categoryChart = new Chart(newCanvas, {
        type: 'line',
        data: {
          labels: categories.map(c => c.name),
          datasets: [{
            label: 'Tickets',
            data: categories.map(c => c.count),
            borderColor: colors[0],
            backgroundColor: colors[0] + '40',
            fill: true,
            tension: 0.3,
            pointRadius: 5,
            pointHoverRadius: 7
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (context) => {
                  const cat = categories[context.dataIndex];
                  return `${cat.count} tickets (${cat.percentage}%)`;
                }
              }
            }
          },
          scales: {
            x: { grid: { display: false } },
            y: { beginAtZero: true, grid: { color: '#f3f4f6' } }
          }
        }
      });
    }

    function renderTrendChart(timeline, categories) {
      const canvas = document.getElementById('trendChart');
      const container = canvas.parentElement;
      
      if (trendChart) {
        trendChart.destroy();
        trendChart = null;
      }
      
      canvas.remove();
      const newCanvas = document.createElement('canvas');
      newCanvas.id = 'trendChart';
      newCanvas.className = 'w-full h-64';
      container.appendChild(newCanvas);

      const colors = ['#3b82f6', '#8b5cf6', '#ef4444', '#10b981', '#f59e0b', '#6366f1', '#ec4899', '#14b8a6'];

      trendChart = new Chart(newCanvas, {
        type: 'line',
        data: {
          labels: timeline.map(t => t.date),
          datasets: categories.slice(0, 5).map((cat, i) => ({
            label: cat,
            data: timeline.map(t => t[cat] || 0),
            borderColor: colors[i],
            backgroundColor: colors[i] + '20',
            fill: true,
            tension: 0.3,
            pointRadius: 3,
            pointHoverRadius: 5
          }))
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { intersect: false, mode: 'index' },
          plugins: {
            legend: {
              position: 'bottom',
              labels: { boxWidth: 12, padding: 15, usePointStyle: true }
            }
          },
          scales: {
            x: { grid: { display: false }, ticks: { maxTicksLimit: 7 } },
            y: { beginAtZero: true, grid: { color: '#f3f4f6' } }
          }
        }
      });
    }

    function renderAIAdvice(advice, priorityAreas) {
      document.getElementById('ai-advice').innerHTML = `
        <p class="leading-relaxed">${advice}</p>
      `;

      document.getElementById('priority-areas').innerHTML = priorityAreas.map(area => `
        <span class="px-3 py-1.5 bg-[#F38020]/20 text-[#F38020] text-xs font-medium rounded-full">${area}</span>
      `).join('');
    }

    function renderTickets(tickets) {
      const content = document.getElementById('content');
      const empty = document.getElementById('empty');

      if (!tickets || tickets.length === 0) {
        content.innerHTML = '';
        empty.classList.remove('hidden');
        return;
      }

      empty.classList.add('hidden');

      const grouped = {
        open: tickets.filter(t => t.status === 'open'),
        in_progress: tickets.filter(t => t.status === 'in_progress'),
        closed: tickets.filter(t => t.status === 'closed')
      };

      const statusConfig = {
        open: { label: 'Open', color: 'green', icon: 'M22 11.08V12a10 10 0 1 1-5.93-9.14' },
        in_progress: { label: 'In Progress', color: 'yellow', icon: 'M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z' },
        closed: { label: 'Closed', color: 'gray', icon: 'M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z' }
      };

      let html = '';
      for (const [status, config] of Object.entries(statusConfig)) {
        const items = grouped[status];
        if (items && items.length > 0) {
          html += `
            <details class="group/section border border-gray-100 rounded-xl overflow-hidden">
              <summary class="px-5 py-4 bg-gray-50 border-b border-gray-100 flex items-center gap-3 cursor-pointer hover:bg-gray-100 transition-colors list-none">
                <svg class="w-5 h-5 text-${config.color}-500 group-open/section:rotate-90 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${config.icon}"/>
                </svg>
                <h2 class="text-lg font-medium text-black">${config.label}</h2>
                <span class="ml-auto px-2 py-1 bg-${config.color}-100 text-${config.color}-700 text-xs font-medium rounded-full">${items.length}</span>
              </summary>
              <div class="divide-y divide-gray-50">
                ${items.map(t => `
                  <details class="group/ticket">
                    <summary class="px-5 py-4 cursor-pointer hover:bg-gray-50 transition-colors flex items-center gap-4 list-none">
                      <span class="font-mono text-sm text-gray-500">${t.ticket_id}</span>
                      <span class="text-sm text-gray-900 truncate flex-1">${t.content}</span>
                      <span class="text-xs text-gray-400">${formatDate(t.created_at)}</span>
                      <svg class="w-4 h-4 text-gray-400 group-open/ticket:rotate-180 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                      </svg>
                    </summary>
                    <div class="px-5 pb-5">
                      <div class="pl-4 border-l-2 border-gray-100 space-y-3">
                        <div>
                          <span class="text-xs font-medium text-gray-500 uppercase">Content</span>
                          <p class="text-sm text-gray-900 mt-1">${t.content}</p>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                          <div>
                            <span class="text-xs font-medium text-gray-500 uppercase">User ID</span>
                            <p class="text-sm font-mono text-gray-600 mt-1">${t.user_id}</p>
                          </div>
                          <div>
                            <span class="text-xs font-medium text-gray-500 uppercase">Created</span>
                            <p class="text-sm text-gray-600 mt-1">${formatDate(t.created_at)}</p>
                          </div>
                        </div>
                      </div>
                    </div>
                  </details>
                `).join('')}
              </div>
            </details>
          `;
        }
      }

      content.innerHTML = html;
    }

    loadAllData();
  </script>
</body>
</html>
